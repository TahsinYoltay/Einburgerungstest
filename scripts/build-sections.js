/* eslint-disable @typescript-eslint/no-var-requires */
const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

const ROOT = path.join(__dirname, '..');
const BOOK_DIR = path.join(ROOT, 'src', 'assets', 'bookEpub');
const CHAPTERS_JSON = path.join(ROOT, 'src', 'assets', 'content', 'chapters.json');
const OUTPUT_TS = path.join(ROOT, 'src', 'assets', 'content', 'generatedSections.ts');

const fallbackBook = path.join(BOOK_DIR, 'Life-in-the-United-Kingdom-A-Guide-for-New-Residents_-3rd-edition.html');

function run(cmd) {
  return execSync(cmd, { encoding: 'utf8' });
}

function listParts(epubPath) {
  const out = run(`unzip -l \"${epubPath}\"`);
  return out
    .split(/\r?\n/)
    .filter(l => l.includes('OEBPS/part') && l.trim().endsWith('.xhtml'))
    .map(l => l.trim().split(/\s+/).pop())
    .filter(name => !name.toLowerCase().includes('part0000'))
    .sort();
}

function extractFile(epubPath, file) {
  try {
    return run(`unzip -p \"${epubPath}\" \"${file}\"`);
  } catch {
    return '';
  }
}

function buildCss(epubPath) {
  // try OEBPS/ then root
  const cssFiles = ['OEBPS/stylesheet.css', 'OEBPS/page_styles.css', 'stylesheet.css', 'page_styles.css'];
  return cssFiles.map(f => extractFile(epubPath, f)).join('\n');
}

function findOccurrences(haystack, needle) {
  const res = [];
  let idx = haystack.indexOf(needle);
  while (idx !== -1) {
    res.push(idx);
    idx = haystack.indexOf(needle, idx + needle.length);
  }
  return res;
}

function sliceByTitle(content, title, boundaryTitles) {
  const lower = content.toLowerCase();
  const target = title.toLowerCase();
  const positions = findOccurrences(lower, target);
  if (positions.length === 0) return null;
  const start = Math.max(...positions); // last occurrence to skip TOC

  const boundaryPositions = [];
  for (const other of boundaryTitles) {
    if (other.toLowerCase() === target) continue;
    boundaryPositions.push(...findOccurrences(lower, other.toLowerCase()).filter(p => p > start));
  }
  const end = boundaryPositions.length > 0 ? Math.min(...boundaryPositions) : content.length;
  return content.slice(start, end);
}

function wrap(html, styles) {
  if (!html.includes('<body')) {
    return `<!DOCTYPE html><html><head>${styles}</head><body>${html}</body></html>`;
  }
  if (html.includes('</head>')) {
    return html.replace('</head>', `${styles}</head>`);
  }
  return `${styles}${html}`;
}

function buildFromEpub(epubPath, chaptersMeta) {
  const map = {};
  const cssText = buildCss(epubPath);
  const parts = listParts(epubPath);
  const mainPart = parts[parts.length - 1] || parts[0];
  const content = mainPart ? extractFile(epubPath, mainPart) : '';
  const fallback = fs.existsSync(fallbackBook) ? fs.readFileSync(fallbackBook, 'utf8') : '';

  for (const chapter of chaptersMeta) {
    const boundaryTitles = chaptersMeta.flatMap(c => c.sections.map(s => s.title));
    for (const section of chapter.sections) {
      let slice = null;
      if (content) {
        slice = sliceByTitle(content, section.title, boundaryTitles);
        if (slice && slice.trim().length < 200) slice = null;
      }
      if (!slice && content) {
        slice = content; // fallback to whole chapter part
      }
      const html = slice && slice.trim().length > 0 ? slice : `<p>Missing content for ${section.title}</p>`;
      map[section.id] = wrap(html, cssText);
    }
  }

  return map;
}

function generate() {
  const chapters = JSON.parse(fs.readFileSync(CHAPTERS_JSON, 'utf8')).chapters;
  const result = {};

  for (const chapter of chapters) {
    const epubPath = path.join(BOOK_DIR, `Chapter${chapter.id}.epub`);
    const usePath = fs.existsSync(epubPath) ? epubPath : fallbackBook;
    const chapterMap = buildFromEpub(usePath, [chapter]);
    Object.assign(result, chapterMap);
  }

  const out = [
    '// Auto-generated by scripts/build-sections.js',
    'export const generatedSectionHtml: Record<string, string> = ',
    JSON.stringify(result, null, 2),
    ';'
  ].join('\n');

  fs.writeFileSync(OUTPUT_TS, out, 'utf8');
  console.log('Generated', OUTPUT_TS, 'with', Object.keys(result).length, 'sections');
}

generate();
