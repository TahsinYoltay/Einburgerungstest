const { execSync } = require('child_process');
const { writeFileSync, readFileSync } = require('fs');
const path = require('path');

const EPUB_PATH = path.join(__dirname, '..', 'src', 'assets', 'bookEpub', 'Life in the United Kingdom A Guide for New Residents, 3rd edition.epub');
const CHAPTERS_JSON = path.join(__dirname, '..', 'src', 'assets', 'content', 'chapters.json');
const OUTPUT_TS = path.join(__dirname, '..', 'src', 'assets', 'content', 'generatedSections.ts');

function run(cmd) {
  return execSync(cmd, { encoding: 'utf8' });
}

function listParts() {
  const out = run(`unzip -l "${EPUB_PATH}"`);
  const lines = out.split(/\r?\n/).filter(l => l.includes('OEBPS/part') && l.trim().endsWith('.xhtml'));
  return lines.map(l => l.trim().split(/\s+/).pop()).sort();
}

function extractFile(file) {
  try {
    return run(`unzip -p "${EPUB_PATH}" "${file}"`);
  } catch (e) {
    return '';
  }
}

function buildCss() {
  const cssFiles = ['stylesheet.css', 'page_styles.css'];
  return cssFiles.map(extractFile).join('\n');
}

function sliceByTitle(html, target, allTitles) {
  const lower = html.toLowerCase();
  const start = lower.indexOf(target.toLowerCase());
  if (start === -1) return null;
  let end = html.length;
  for (const title of allTitles) {
    if (title.toLowerCase() === target.toLowerCase()) continue;
    const pos = lower.indexOf(title.toLowerCase(), start + 1);
    if (pos !== -1 && pos < end) end = pos;
  }
  return html.slice(start, end);
}

function wrap(html, css) {
  if (!html.includes('<body')) {
    return `<!DOCTYPE html><html><head><style>${css}</style></head><body>${html}</body></html>`;
  }
  if (html.includes('</head>')) {
    return html.replace('</head>', `<style>${css}</style></head>`);
  }
  return `<style>${css}</style>${html}`;
}

function generate() {
  const chapters = JSON.parse(readFileSync(CHAPTERS_JSON, 'utf8')).chapters;
  const parts = listParts();
  const cssText = buildCss();
  const map = {};

  for (const chapter of chapters) {
    const titles = chapter.sections.map(s => s.title);
    for (const section of chapter.sections) {
      let best = null;
      for (const part of parts) {
        const raw = extractFile(part);
        if (!raw) continue;
        if (raw.toLowerCase().includes(section.title.toLowerCase())) {
          if (!best || raw.length > best.raw.length) {
            best = { raw, part };
          }
        }
      }
      let html = best ? sliceByTitle(best.raw, section.title, titles) || best.raw : '';
      map[section.id] = wrap(html || `<p>Missing content for ${section.title}</p>`, cssText);
    }
  }

  const content = `// Auto-generated by scripts/generate-section-html.js\nexport const generatedSectionHtml: Record<string, string> = ${JSON.stringify(map, null, 2)};\n`;
  writeFileSync(OUTPUT_TS, content, 'utf8');
  console.log('Generated', OUTPUT_TS);
}

generate();
