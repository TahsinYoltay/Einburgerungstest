rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    
    // --- Book Content ---
    match /BookData/{fileName=**} {
      allow read: if true;
      allow write: if false; 
    }
    match /assets/bookImages/{imageName=**} {
      allow read: if true;
      allow write: if false; 
    }
    match /assets/BookData/{fileName=**} {
      allow read: if true;
      allow write: if false; 
    }
    
    // --- Dynamic Exam Content ---
    
    // 0. Allow reading Global Config (manifest.json, etc.)
    match /config/{fileName=**} {
      allow read: if true;
      allow write: if false; 
    }

    // 1. Allow reading the Manifests (languages.json, exams.json)
    match /exam/config/{fileName=**} {
      allow read: if true;
      allow write: if false; 
    }

    // 2. Allow reading the Translations (allChaptersData.xx.json)
    match /exam/translations/{fileName=**} {
      allow read: if true;
      allow write: if false; 
    }

    // 3. Allow reading Mock Exam content (mockExam.xx.json)
    match /exam/mockExam/{fileName=**} {
      allow read: if true;
      allow write: if false;
    }

    // 4. Allow reading Chapter Test content (questionsByChapter.xx.json)
    match /exam/chapterName/{fileName=**} {
      allow read: if true;
      allow write: if false;
    }
    match /exam/chapterQuestions/{fileName=**} {
      allow read: if true;
      allow write: if false;
    }

    // 5. Allow reading dynamic UI content (e.g., home.json)
    match /content/{fileName=**} {
      allow read: if true;
      allow write: if false; 
    }

    // 6. Allow reading Book Content (bookContent.xx.json)
    match /book/content/{fileName=**} {
      allow read: if true;
      allow write: if false; 
    }

    // --- User Uploads (Avatars) ---
    match /user_uploads/avatars/{uid}/{fileName=**} {
      allow read: if request.auth != null && request.auth.uid == uid;
      allow create, update: if request.auth != null
        && request.auth.uid == uid
        && request.resource != null
        && request.resource.size < 5 * 1024 * 1024
        && request.resource.contentType.matches('image/.*');
      allow delete: if request.auth != null && request.auth.uid == uid;
    }

    // --- Default Block ---
    // Explicitly deny all other access to prevent unauthorized writes
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
